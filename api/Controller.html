<!DOCTYPE html>

<html>
<head>
  <title>Controller.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="layout.css" />
  <style>
    /*--------------------- Layout and Typography ----------------------------*/
body { font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif; font-size: 15px; line-height: 22px; color: #252519; margin: 0; padding: 0;
}
a { color: #261a3b;
} a:visited { color: #261a3b; }
p { margin: 0 0 15px 0;
}
h1, h2, h3, h4, h5, h6 { margin: 40px 0 15px 0;
} h3, h4, h5, h6 { margin-top: 20px; }
#container { position: relative;
}
#background { position: fixed; top: 0; left: 575px; right: 0; bottom: 0; background: #f5f5ff; border-left: 1px solid #e5e5ee; z-index: -1;
}
#jump_to, #jump_page { background: white; -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777; -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px; font: 10px Arial; text-transform: uppercase; cursor: pointer; text-align: right;
}
#jump_to, #jump_wrapper { position: fixed; right: 0; top: 0; padding: 5px 10px;
} #jump_wrapper { padding: 0; display: none; } #jump_to:hover #jump_wrapper { display: block; } #jump_page { padding: 5px 0 3px; margin: 0 0 25px 25px; overflow:hidden; } #jump_page .source { display: block; padding: 5px 10px; text-decoration: none; border-top: 1px solid #eee; float:left; min-width:180px; text-align:left; text-transform:none; font-size:11px; } #jump_page .source:hover { background: #f5f5ff; } #jump_page .source:first-child { }
table td { border: 0; outline: 0;
} td.docs, th.docs { max-width: 450px; min-width: 450px; min-height: 5px; padding: 10px 25px 1px 50px; overflow-x: hidden; vertical-align: top; text-align: left; } .docs pre { margin: 15px 0 15px; padding-left: 15px; } .docs p tt, .docs p code { background: #f8f8ff; border: 1px solid #dedede; font-size: 12px; padding: 0 0.2em; } .pilwrap { position: relative; } .pilcrow { font: 12px Arial; text-decoration: none; color: #454545; position: absolute; top: 3px; left: -20px; padding: 1px 2px; opacity: 0; -webkit-transition: opacity 0.2s linear; } td.docs:hover .pilcrow { opacity: 1; } td.code, th.code { padding: 14px 15px 16px 25px; width: 100%; vertical-align: top; background: #f5f5ff; border-left: 1px solid #e5e5ee; } pre, tt, code { font-size: 12px; line-height: 18px; font-family: Monaco, Consolas, "Lucida Console", monospace; margin: 0; padding: 0; } /*---------------------- Syntax Highlighting -----------------------------*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
body .hll { background-color: #ffffcc }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #954121 } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #808080 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0040D0 } /* Generic.Traceback */
body .kc { color: #954121 } /* Keyword.Constant */
body .kd { color: #954121; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #954121; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #954121 } /* Keyword.Pseudo */
body .kr { color: #954121; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #219161 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #954121 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #954121; font-weight: bold } /* Name.Tag */
body .nv { color: #19469D } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #219161 } /* Literal.String.Backtick */
body .sc { color: #219161 } /* Literal.String.Char */
body .sd { color: #219161; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #219161 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #219161 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #954121 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #219161 } /* Literal.String.Single */
body .ss { color: #19469D } /* Literal.String.Symbol */
body .bp { color: #954121 } /* Name.Builtin.Pseudo */
body .vc { color: #19469D } /* Name.Variable.Class */
body .vg { color: #19469D } /* Name.Variable.Global */
body .vi { color: #19469D } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */ /********** PHP Comment Additions ********/
td.docs .docparam {color:#DB251A;font-weight:bold;}
  </style>
</head>
<body>
  <div id="container">
    <div id="background"></div>
          <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
          <div id="jump_page">
                                          <a class="source" href="./ActiveResource.html">
                              ActiveResource.php              </a>
                                          <a class="source" href="./Autoloader.html">
                              Autoloader.php              </a>
                                          <a class="source" href="./Cache.html">
                              Cache.php              </a>
                                          <a class="source" href="./Controller.html">
                              Controller.php              </a>
                                          <a class="source" href="./Database.html">
                              Database.php              </a>
                                          <a class="source" href="./Debugger.html">
                              Debugger.php              </a>
                                          <a class="source" href="./Form.html">
                              Form.php              </a>
                                          <a class="source" href="./Functions.html">
                              Functions.php              </a>
                                          <a class="source" href="./I18n.html">
                              I18n.php              </a>
                                          <a class="source" href="./MemcacheExt.html">
                              MemcacheExt.php              </a>
                                          <a class="source" href="./Model.html">
                              Model.php              </a>
                                          <a class="source" href="./MongoManager.html">
                              MongoManager.php              </a>
                                          <a class="source" href="./MongoModel.html">
                              MongoModel.php              </a>
                                          <a class="source" href="./Page.html">
                              Page.php              </a>
                                          <a class="source" href="./Product.html">
                              Product.php              </a>
                                          <a class="source" href="./Restful.html">
                              Restful.php              </a>
                                          <a class="source" href="./Template.html">
                              Template.php              </a>
                      </div>
        </div>
      </div>
        <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              Controller.php            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
                  <tr id="section-0">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-0">&#182;</a>
              </div>
              <p>Elefant CMS - http:www.elefantcms.com/</p>

<p>Copyright (c) 2011 Johnny Broadway</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-1">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Basic routing controller. Maps <code>$_SERVER['REQUEST_URI']</code> to files in
 a <code>apps/{appname}/handlers/</code> folder, defaulting to
 <code>$conf['General']['default_handler']</code> if no others match.</p>

<p>Matching is done by reducing the URL folder-by-folder until a file
 matches. Here are some examples:</p>

<pre><code> / -&gt; $conf[default_handler]

 /foo -&gt; apps/foo/handlers/index.php,
         $conf[default_handler]

 /user/login -&gt; apps/user/handlers/login.php,
                apps/user/handlers/index.php,
                $conf[default_handler]

 /user/info/123 -&gt; apps/user/handlers/info/123.php,
                   apps/user/handlers/info.php,
                   apps/user/handlers/index.php,
                   $conf[default_handler]
</code></pre>

<p>The controller simply returns the matching URL so you can include
 it via the following code:</p>

<pre><code> $handler = $controller-&gt;route ($_SERVER['REQUEST_URI']);
 ob_start ();
 require_once ($handler);
 $page-&gt;body = ob_get_clean ();
</code></pre>

<p>Or more simply (but in practice the same):</p>

<pre><code> $handler = $controller-&gt;route ($_SERVER['REQUEST_URI']);
 $page-&gt;body = $controller-&gt;handle ($handler);
</code></pre>

<p>In this way, there is less scaffolding code for individual controllers,
 they can simply begin executing just like an ordinary PHP script, and
 the output is simply echoed like an ordinary PHP script too.</p>

<p>The remaining elements of the URL are accessible in the array
 <code>$this-&gt;params</code>, so for <code>/user/123</code> handled by <code>handlers/user.php</code>,
 you could get the value <code>'123'</code> via <code>$this-&gt;params[0]</code>.</p>

<p>To use named parameters, you simply say:</p>

<pre><code> list ($id, $title) = $this-&gt;params;
</code></pre>

<p>You can also call one handler from within another and get its results
 like this:</p>

<pre><code> $res = $this-&gt;run ('/user/123');
</code></pre>

<p>Sometimes you might want to pass values to another handler for internal
 processing, which you can do like this:</p>

<pre><code> $res = $this-&gt;run ('/user/123', array ('foo' =&gt; 'bar'));
</code></pre>

<p>You can then access the array via:</p>

<pre><code> echo $this-&gt;data['foo'];
</code></pre>

<p>In addition to running one handler from another, you can configure
 hooks with one or more handlers to be run for you when you trigger
 the hook. This is a 3-step process:</p>

<ol>
<li><p>Add your hook and its handler to <code>conf/config.php</code>:</p>

<p>myapp/somehandler[] = otherapp/handler</p></li>
<li><p>In <code>myapp/somehandler</code>, add the hook call and pass it some data:</p>

<p>$this->hook ('myapp/somehandler', array('id' => 123));</p></li>
<li><p>In <code>otherapp/handler</code>, verify the request and do something
interesting with the id:</p>

<p>&lt;?php</p>

<p>if (! $this->internal) {
     die ('Cannot call me from a browser.');
 }</p>

<p>if (! Form::verify_value ($this->data['id'], 'type', 'numeric')) {
     die ('Invalid id value');
 }</p>

<p>do something with $this->data['id']</p>

<p>?></p></li>
</ol>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">class</span> <span class="nc">Controller</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Extra parameters from the end of the URL.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-3">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Whether the request originated internally or externally.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$internal</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-4">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Data sent from another handler to the current one.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-5">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Set to true if the request came from the command line.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$cli</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-6">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>A list of handlers defined to be called for each type of hook.
 Similar to the idea of webhooks, this provides a means of triggering
 handlers from each other without hard-coding the specific handlers in
 the triggering code. See <code>conf/config.php</code>'s <code>[Hooks]</code> section for examples.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">static</span> <span class="nv">$hooks</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-7">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Keeps track of the number of times each handler has been called in
 this request. You can check <code>self::$called['handler']</code> for the
 number.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">static</span> <span class="nv">$called</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-8">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Cached PUT data from get<em>put</em>data() so it only reads it the first
 time.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$put_data</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-9">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The app that is being called. Set by <code>route()</code>.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$app</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-10">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The uri that was last called, as parsed by <code>route()</code>. This will have
 preceding slashes trimmed, and if it resolves to a default like
 <code>app -&gt; app/index</code>, then it will have the <code>/index</code> added.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$uri</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-11">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>When a handler is loaded, if there is a <code>conf/config.php</code> for that
 app, its contents will be loaded into <code>$appconf['appname']</code> once
 the first time it is called, and accessible thereafter by any
 handler in that app directly via $appconf.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">static</span> <span class="nv">$appconf</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-12">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>This will be set the first time chunked() is called, so the controller
 knows it's already started sending the response with
 <code>Transfer-Encoding: chunked</code>.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$chunked</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-13">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Whether the current handler's output should be cached automatically
 when it returns. Set to <code>true</code> to cache indefinitely, and a number
 to set a timeout in seconds. The cache key will be the app and handler
 name, with slashes converted to underscores, e.g., <code>myapp_handler</code>.</p>

<p>Usage:</p>

<pre><code>  cache indefinitely
 $this-&gt;cache = true;

  cache for 5 minutes
 $this-&gt;cache = 300;
</code></pre>

<p>To clear a cached handler before its time, which you would have to
 do from a separate handler since the original won't be called while
 cached, you can use:</p>

<pre><code> $memcache-&gt;delete ('myapp_handler');
</code></pre>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="nv">$cache</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-14">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Constructor method.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span> <span class="p">(</span><span class="nv">$hooks</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="p">(</span><span class="s1">&#39;STDIN&#39;</span><span class="p">))</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cli</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">self</span><span class="o">::</span><span class="nv">$hooks</span> <span class="o">=</span> <span class="nv">$hooks</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-15">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Run an internal request from one handler to another.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="nv">$c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Controller</span><span class="p">;</span>
  <span class="nv">$handler</span> <span class="o">=</span> <span class="nv">$c</span><span class="o">-&gt;</span><span class="na">route</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$called</span><span class="p">[</span><span class="nv">$uri</span><span class="p">]))</span> <span class="p">{</span>
   <span class="nx">self</span><span class="o">::</span><span class="nv">$called</span><span class="p">[</span><span class="nv">$uri</span><span class="p">]</span> <span class="o">=</span> <span class="m">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="nx">self</span><span class="o">::</span><span class="nv">$called</span><span class="p">[</span><span class="nv">$uri</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nv">$c</span><span class="o">-&gt;</span><span class="na">handle</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-16">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Trigger the default error handler. Note that you must echo the
 output from your handler before returning, for example:</p>

<pre><code> echo $this-&gt;error ();
 return;
</code></pre>

<p>Not like this:</p>

<pre><code> return $this-&gt;error ();
</code></pre>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">error</span> <span class="p">(</span><span class="nv">$code</span> <span class="o">=</span> <span class="m">404</span><span class="p">,</span> <span class="nv">$title</span> <span class="o">=</span> <span class="s1">&#39;Page not found&#39;</span><span class="p">,</span> <span class="nv">$message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-17">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Erase any existing output up to this point</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nb">ob_clean</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-18">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Call the error handler</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">run</span> <span class="p">(</span><span class="nx">conf</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;error_handler&#39;</span><span class="p">),</span> <span class="k">array</span> <span class="p">(</span>
   <span class="s1">&#39;code&#39;</span> <span class="o">=&gt;</span> <span class="nv">$code</span><span class="p">,</span>
   <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
   <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$message</span>
  <span class="p">));</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-19">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Run any handlers for the specified hook type. Note that the
 output for hooks is ignored.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">hook</span> <span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$hooks</span><span class="p">[</span><span class="nv">$type</span><span class="p">]))</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$hooks</span><span class="p">[</span><span class="nv">$type</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$handler</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">run</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-20">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Takes a list of names as arguments and returns an associative
 array of the handler parameters using the names as keys. Note
 that it will return false if the number of names is different
 than the number of parameters. Handy for using named parameters
 via:</p>

<pre><code> extract ($this-&gt;params ('id', 'title'));
</code></pre>

<p>Note that you can also achieve the same thing via:</p>

<pre><code> list ($id, $title) = $this-&gt;params;
</code></pre>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">params</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nv">$keys</span> <span class="o">=</span> <span class="nb">func_get_args</span> <span class="p">();</span>
  <span class="k">return</span> <span class="nb">array_combine</span> <span class="p">(</span><span class="nv">$keys</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">);</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-21">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Execute the request handler. $internal determines whether the
 request originated internally from another handler or template,
 or externally from a browser request.</p>

<p>Note: We use three globals here. This may raise some flags in
 you as a developer, but hear me out. These are global singletons
 that the front controller creates for us, and I want to be able
 to use them in handlers directly without first instantiating them,
 through a <code>::getInstance()</code> call or otherwise. I know it's bad
 form in general, but this is <em>by design</em> to save typing in handlers
 and happens for these three objects only.</p>

<p>I also could have simply added them as properties of <code>$this</code>, but
 that would add typing too (e.g., <code>$this-&gt;view-&gt;render</code> vs
 <code>$tpl-&gt;render</code>). I'm opting for conciseness. And as it is, I'm
 deliberately making an ordinary script act like a controller, minus
 the class wrapping it. It's a stylistic decision, and if it's not
 your cup of tea, that's cool. It is mine, however :)</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$internal</span> <span class="o">=</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="k">global</span> <span class="nv">$page</span><span class="p">,</span> <span class="nv">$tpl</span><span class="p">,</span> <span class="nv">$memcache</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-22">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Check for a cached copy of this handler's output</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$out</span> <span class="o">=</span> <span class="nv">$memcache</span><span class="o">-&gt;</span><span class="na">get</span> <span class="p">(</span><span class="nb">str_replace</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$out</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
  <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-23">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Set the handler data</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">internal</span> <span class="o">=</span> <span class="nv">$internal</span><span class="p">;</span>
  <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-24">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Load the app's configuration settings if available</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">]))</span> <span class="p">{</span>
   <span class="k">try</span> <span class="p">{</span>
    <span class="nx">self</span><span class="o">::</span><span class="nv">$appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">.</span> <span class="s1">&#39;/conf/config.php&#39;</span><span class="p">)</span>
     <span class="o">?</span> <span class="nb">parse_ini_file</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">.</span> <span class="s1">&#39;/conf/config.php&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
     <span class="o">:</span> <span class="k">array</span> <span class="p">();</span>
   <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="o">::</span><span class="nv">$appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
   <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$appconf</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">];</span></pre></div>            </td>
          </tr>
                  <tr id="section-25">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Run the handler and get its output</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nb">ob_start</span> <span class="p">();</span>
  <span class="k">require</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>
  <span class="nv">$out</span> <span class="o">=</span> <span class="nb">ob_get_clean</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-26">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If this is a chunked request, flush and exit</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">chunked</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flush</span> <span class="p">(</span><span class="nv">$out</span><span class="p">);</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flush</span> <span class="p">(</span><span class="k">null</span><span class="p">);</span>
  <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-27">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>If the handler is cacheable, cache the results before returning</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$timeout</span> <span class="o">=</span> <span class="nb">is_numeric</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cache</span> <span class="o">:</span> <span class="m">0</span><span class="p">;</span>
   <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$memcache</span><span class="o">-&gt;</span><span class="na">replace</span> <span class="p">(</span><span class="nb">str_replace</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">),</span> <span class="nv">$out</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="nv">$timeout</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$memcache</span><span class="o">-&gt;</span><span class="na">set</span> <span class="p">(</span><span class="nb">str_replace</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">),</span> <span class="nv">$out</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="nv">$timeout</span><span class="p">);</span>
   <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$out</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-28">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Route a request URI to a file.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">route</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$exp</span> <span class="o">=</span> <span class="nb">explode</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">conf</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;default_handler&#39;</span><span class="p">));</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">=</span> <span class="nb">array_shift</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-29">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Remove queries and hash from uri</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">preg_replace</span> <span class="p">(</span><span class="s1">&#39;/(\?|#).*$/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clean</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$uri</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$uri</span> <span class="o">=</span> <span class="nx">conf</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;default_handler&#39;</span><span class="p">);</span>
  <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-30">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Remove leading /</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">ltrim</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-31">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>If no / and doesn't match an app's name with an index.php</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-32">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>handler, then use the default handler.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">strstr</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$uri</span> <span class="o">.</span> <span class="s1">&#39;/handlers/index.php&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$uri</span> <span class="o">.=</span> <span class="s1">&#39;/index&#39;</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add_param</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>
    <span class="nv">$uri</span> <span class="o">=</span> <span class="nx">conf</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;default_handler&#39;</span><span class="p">);</span>
   <span class="p">}</span>
  <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-33">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Determine the handler by cascading through potential file names</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-34">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>until one matches.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">list</span> <span class="p">(</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$handler</span><span class="p">)</span> <span class="o">=</span> <span class="nb">preg_split</span> <span class="p">(</span><span class="s1">&#39;/\//&#39;</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="m">2</span><span class="p">);</span>
  <span class="nv">$route</span> <span class="o">=</span> <span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers/&#39;</span> <span class="o">.</span> <span class="nv">$handler</span> <span class="o">.</span> <span class="s1">&#39;.php&#39;</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="nv">$route</span><span class="p">))</span> <span class="p">{</span>
   <span class="nv">$route</span> <span class="o">=</span> <span class="nb">preg_replace</span> <span class="p">(</span><span class="s1">&#39;/\/([^\/]*)\.php$/e&#39;</span><span class="p">,</span> <span class="s1">&#39;$this-&gt;add_param (\&#39;\\1\&#39;)&#39;</span><span class="p">,</span> <span class="nv">$route</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nv">$route</span> <span class="o">===</span> <span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers.php&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers/index.php&#39;</span><span class="p">))</span> <span class="p">{</span>
     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">=</span> <span class="nv">$app</span><span class="p">;</span>
     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span> <span class="o">=</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/index&#39;</span><span class="p">;</span>
     <span class="k">return</span> <span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers/index.php&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">=</span> <span class="nv">$app</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span> <span class="o">=</span> <span class="nx">conf</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;default_handler&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">vsprintf</span> <span class="p">(</span>
     <span class="s1">&#39;apps/%s/handlers/%s.php&#39;</span><span class="p">,</span>
     <span class="nb">explode</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">conf</span> <span class="p">(</span><span class="s1">&#39;General&#39;</span><span class="p">,</span> <span class="s1">&#39;default_handler&#39;</span><span class="p">))</span>
    <span class="p">);</span>
   <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">=</span> <span class="nv">$app</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span> <span class="o">=</span> <span class="nv">$uri</span><span class="p">;</span>
  <span class="k">return</span> <span class="nv">$route</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-35">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Is this URL clean of any directory manipulation attempts?</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">clean</span> <span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span> <span class="nb">strstr</span> <span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">);</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-36">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Adds to the start, since <code>route()</code> parse them off the end of the URI.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">add_param</span> <span class="p">(</span><span class="nv">$param</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">array_unshift</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">,</span> <span class="nv">$param</span><span class="p">);</span>
  <span class="k">return</span> <span class="s1">&#39;.php&#39;</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-37">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Add a notification to the <code>elefant_notification</code> cookie, which is
 monitored by <code>admin/head</code> and will be displayed using jGrowl. Handy
 for setting confirmation messages and other notices for the current
 user to display on a subsequent screen.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">add_notification</span> <span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span> <span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;elefant_notification&#39;</span><span class="p">]))</span> <span class="p">{</span>
   <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;elefant_notification&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;|&#39;</span> <span class="o">.</span> <span class="nv">$msg</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">setcookie</span> <span class="p">(</span><span class="s1">&#39;elefant_notification&#39;</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-38">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Redirect the current request and exit.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">redirect</span> <span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$exit</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">header</span> <span class="p">(</span><span class="s1">&#39;Location: &#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$exit</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">quit</span> <span class="p">();</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-39">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Wrapper around exit to work with subfolder installations.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">quit</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">defined</span> <span class="p">(</span><span class="s1">&#39;SUB_FOLDER&#39;</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">exit</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nx">SubfolderException</span> <span class="p">();</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-40">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Get the stdin stream for PUT requests.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">get_put_data</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">put_data</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$stdin</span> <span class="o">=</span> <span class="nb">fopen</span> <span class="p">(</span><span class="s1">&#39;php://input&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">);</span>
   <span class="nv">$out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
   <span class="k">while</span> <span class="p">(</span><span class="nv">$data</span> <span class="o">=</span> <span class="nb">fread</span> <span class="p">(</span><span class="nv">$stdin</span><span class="p">,</span> <span class="m">1024</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$out</span> <span class="o">.=</span> <span class="nv">$data</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nb">fclose</span> <span class="p">(</span><span class="nv">$stdin</span><span class="p">);</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">put_data</span> <span class="o">=</span> <span class="nv">$out</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">put_data</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-41">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Get the raw POST data.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">get_raw_post_data</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;HTTP_RAW_POST_DATA&#39;</span><span class="p">];</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-42">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Get the request method. If X-HTTP-Method-Override header is set,
 it will return that instead of the actual request method.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">request_method</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">isset</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_X_HTTP_METHOD_OVERRIDE&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_X_HTTP_METHOD_OVERRIDE&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">];</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-43">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Use an object's methods to handle RESTful requests for the current handler.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">restful</span> <span class="p">(</span><span class="nv">$obj</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-44">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Disable page layout and set JSON header.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">global</span> <span class="nv">$page</span><span class="p">;</span>
  <span class="nv">$page</span><span class="o">-&gt;</span><span class="na">layout</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="nb">header</span> <span class="p">(</span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-45">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Verify an action has been specified.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="m">0</span><span class="p">]))</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">error</span> <span class="p">(</span><span class="s1">&#39;No action specified&#39;</span><span class="p">);</span>
  <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-46">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Method names are the request method plus the first parameter</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-47">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>after the handler name, e.g. GET /myapp/api/action_name would</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-48">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>call get<em>action</em>name().</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$method</span> <span class="o">=</span> <span class="nb">strtolower</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request_method</span> <span class="p">())</span> <span class="o">.</span> <span class="s1">&#39;_&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="m">0</span><span class="p">];</span></pre></div>            </td>
          </tr>
                  <tr id="section-49">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Verify the method exists.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">method_exists</span> <span class="p">(</span><span class="nv">$obj</span><span class="p">,</span> <span class="nv">$method</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">error</span> <span class="p">(</span><span class="s1">&#39;Invalid action name&#39;</span><span class="p">);</span>
  <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-50">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Assign the controller to the object.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">controller</span> <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-51">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Call the method with the extra URL parameters.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$params</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">;</span>
  <span class="nb">array_shift</span> <span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
  <span class="nv">$res</span> <span class="o">=</span> <span class="nb">call_user_func_array</span> <span class="p">(</span><span class="k">array</span> <span class="p">(</span><span class="nv">$obj</span><span class="p">,</span> <span class="nv">$method</span><span class="p">),</span> <span class="nv">$params</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-52">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>If an error hasn't been output already, encode the response.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">wrap</span> <span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-53">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Changes the response to use <code>Transfer-Encoding: chunked</code> and sends
 the current buffer to the client. Call this each time you want the
 script to send the next chunk of data to the client.</p>

<p>Note that this will cause render() to call <code>flush(null)</code> at the end,
 which will not return your output to be included in a page layout.
 It will also flush and exit prior to setting a controller-level
 cache of your output.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">flush</span> <span class="p">(</span><span class="nv">$out</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">chunked</span><span class="p">)</span> <span class="p">{</span>
   <span class="nb">header</span> <span class="p">(</span><span class="s1">&#39;Transfer-Encoding: chunked&#39;</span><span class="p">);</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">chunked</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$out</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-54">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Send an empty chunk and exit</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="nb">ob_get_level</span> <span class="p">()</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-55">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Flush any existing data first</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flush</span> <span class="p">();</span>
   <span class="p">}</span>
   <span class="k">echo</span> <span class="s2">&quot;0</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">;</span>
   <span class="nb">flush</span> <span class="p">();</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">quit</span> <span class="p">();</span>
  <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$out</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-56">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Send the data passed to flush()</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span> <span class="p">(</span><span class="nv">$out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span> <span class="p">(</span><span class="s2">&quot;%X</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">strlen</span> <span class="p">(</span><span class="nv">$out</span><span class="p">));</span>
    <span class="k">echo</span> <span class="nv">$out</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="nb">flush</span> <span class="p">();</span>
   <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-57">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Send the current output buffer contents</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>   <span class="nv">$out</span> <span class="o">=</span> <span class="nb">ob_get_clean</span> <span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span> <span class="p">(</span><span class="nv">$out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">printf</span> <span class="p">(</span><span class="s2">&quot;%X</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">strlen</span> <span class="p">(</span><span class="nv">$out</span><span class="p">));</span>
    <span class="k">echo</span> <span class="nv">$out</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="nb">flush</span> <span class="p">();</span>
   <span class="p">}</span>
   <span class="nb">ob_start</span> <span class="p">();</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-58">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Returns whether the current request is made over HTTPS or not.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">is_https</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTPS&#39;</span><span class="p">])</span> <span class="o">||</span> <span class="nb">strtolower</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTPS&#39;</span><span class="p">])</span> <span class="o">!==</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-59">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Forces the current request to be over HTTPS instead of HTTP
 via redirect if necessary.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">force_https</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">is_https</span> <span class="p">())</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span> <span class="p">(</span><span class="s1">&#39;https://&#39;</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]);</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-60">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Forces the current request to be over HTTP instead of HTTPS
 via redirect if necessary.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">force_http</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">is_https</span> <span class="p">())</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span> <span class="p">(</span><span class="s1">&#39;http://&#39;</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]);</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-61">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Require the user to be logged in to proceed with the request.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">require_login</span> <span class="p">(</span><span class="nv">$redirect</span> <span class="o">=</span> <span class="s1">&#39;/user/login&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">User</span><span class="o">::</span><span class="na">require_login</span> <span class="p">())</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span> <span class="p">(</span><span class="nv">$redirect</span> <span class="o">.</span> <span class="s1">&#39;?redirect=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]));</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-62">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Require the user to be an administrator to proceed with the request.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">require_admin</span> <span class="p">(</span><span class="nv">$redirect</span> <span class="o">=</span> <span class="s1">&#39;/admin&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">User</span><span class="o">::</span><span class="na">require_admin</span> <span class="p">())</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span> <span class="p">(</span><span class="nv">$redirect</span> <span class="o">.</span> <span class="s1">&#39;?redirect=&#39;</span> <span class="o">.</span> <span class="nb">urlencode</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]));</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-63">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Check if an app and version have been installed. Returns true if
 installed, false if not, and current installed version if an upgrade
 should be performed.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">installed</span> <span class="p">(</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$version</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$v</span> <span class="o">=</span> <span class="nx">db_shift</span> <span class="p">(</span><span class="s1">&#39;select version from apps where name = ?&#39;</span><span class="p">,</span> <span class="nv">$app</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span> <span class="p">(</span><span class="nv">$version</span><span class="p">,</span> <span class="nv">$v</span><span class="p">)</span> <span class="o">===</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$v</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-64">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Mark an app and version as installed.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">public</span> <span class="k">function</span> <span class="nf">mark_installed</span> <span class="p">(</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$version</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$v</span> <span class="o">=</span> <span class="nx">db_shift</span> <span class="p">(</span><span class="s1">&#39;select version from apps where name = ?&#39;</span><span class="p">,</span> <span class="nv">$app</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">db_execute</span> <span class="p">(</span><span class="s1">&#39;update apps set version = ? where name = ?&#39;</span><span class="p">,</span> <span class="nv">$version</span><span class="p">,</span> <span class="nv">$app</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">db_execute</span> <span class="p">(</span><span class="s1">&#39;insert into apps (name, version) values (?, ?)&#39;</span><span class="p">,</span> <span class="nv">$app</span><span class="p">,</span> <span class="nv">$version</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
</pre></div></pre></div>            </td>
          </tr>
              </tbody>
    </table>
  </div>
</body>
</html>
