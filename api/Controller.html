<!DOCTYPE html>

<html>
<head>
  <title>Controller.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="layout.css" />
  <style>
    /*--------------------- Layout and Typography ----------------------------*/
body { font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif; font-size: 15px; line-height: 22px; color: #252519; margin: 0; padding: 0;
}
a { color: #261a3b;
} a:visited { color: #261a3b; }
p { margin: 0 0 15px 0;
}
h1, h2, h3, h4, h5, h6 { margin: 40px 0 15px 0;
} h3, h4, h5, h6 { margin-top: 20px; }
#container { position: relative;
}
#background { position: fixed; top: 0; left: 575px; right: 0; bottom: 0; background: #f5f5ff; border-left: 1px solid #e5e5ee; z-index: -1;
}
#jump_to, #jump_page { background: white; -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777; -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px; font: 10px Arial; text-transform: uppercase; cursor: pointer; text-align: right;
}
#jump_to, #jump_wrapper { position: fixed; right: 0; top: 0; padding: 5px 10px;
} #jump_wrapper { padding: 0; display: none; } #jump_to:hover #jump_wrapper { display: block; } #jump_page { padding: 5px 0 3px; margin: 0 0 25px 25px; overflow:hidden; } #jump_page .source { display: block; padding: 5px 10px; text-decoration: none; border-top: 1px solid #eee; float:left; min-width:180px; text-align:left; text-transform:none; font-size:11px; } #jump_page .source:hover { background: #f5f5ff; } #jump_page .source:first-child { }
table td { border: 0; outline: 0;
} td.docs, th.docs { max-width: 450px; min-width: 450px; min-height: 5px; padding: 10px 25px 1px 50px; overflow-x: hidden; vertical-align: top; text-align: left; } .docs pre { margin: 15px 0 15px; padding-left: 15px; } .docs p tt, .docs p code { background: #f8f8ff; border: 1px solid #dedede; font-size: 12px; padding: 0 0.2em; } .pilwrap { position: relative; } .pilcrow { font: 12px Arial; text-decoration: none; color: #454545; position: absolute; top: 3px; left: -20px; padding: 1px 2px; opacity: 0; -webkit-transition: opacity 0.2s linear; } td.docs:hover .pilcrow { opacity: 1; } td.code, th.code { padding: 14px 15px 16px 25px; width: 100%; vertical-align: top; background: #f5f5ff; border-left: 1px solid #e5e5ee; } pre, tt, code { font-size: 12px; line-height: 18px; font-family: Monaco, Consolas, "Lucida Console", monospace; margin: 0; padding: 0; } /*---------------------- Syntax Highlighting -----------------------------*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
body .hll { background-color: #ffffcc }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #954121 } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #808080 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0040D0 } /* Generic.Traceback */
body .kc { color: #954121 } /* Keyword.Constant */
body .kd { color: #954121; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #954121; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #954121 } /* Keyword.Pseudo */
body .kr { color: #954121; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #219161 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #954121 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #954121; font-weight: bold } /* Name.Tag */
body .nv { color: #19469D } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #219161 } /* Literal.String.Backtick */
body .sc { color: #219161 } /* Literal.String.Char */
body .sd { color: #219161; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #219161 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #219161 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #954121 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #219161 } /* Literal.String.Single */
body .ss { color: #19469D } /* Literal.String.Symbol */
body .bp { color: #954121 } /* Name.Builtin.Pseudo */
body .vc { color: #19469D } /* Name.Variable.Class */
body .vg { color: #19469D } /* Name.Variable.Global */
body .vi { color: #19469D } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */ /********** PHP Comment Additions ********/
td.docs .docparam {color:#DB251A;font-weight:bold;}
  </style>
</head>
<body>
  <div id="container">
    <div id="background"></div>
          <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
          <div id="jump_page">
                                          <a class="source" href="./ActiveResource.html">
                              ActiveResource.php              </a>
                                          <a class="source" href="./Autoloader.html">
                              Autoloader.php              </a>
                                          <a class="source" href="./Cache.html">
                              Cache.php              </a>
                                          <a class="source" href="./Controller.html">
                              Controller.php              </a>
                                          <a class="source" href="./Database.html">
                              Database.php              </a>
                                          <a class="source" href="./Form.html">
                              Form.php              </a>
                                          <a class="source" href="./Functions.html">
                              Functions.php              </a>
                                          <a class="source" href="./I18n.html">
                              I18n.php              </a>
                                          <a class="source" href="./Model.html">
                              Model.php              </a>
                                          <a class="source" href="./Page.html">
                              Page.php              </a>
                                          <a class="source" href="./Template.html">
                              Template.php              </a>
                      </div>
        </div>
      </div>
        <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              Controller.php            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
                  <tr id="section-0">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-0">&#182;</a>
              </div>
              <p>Basic routing controller. Maps <code>$_SERVER['REQUEST_URI']</code> to files in
 a <code>apps/{appname}/handlers/</code> folder, defaulting to
 <code>$conf['General']['default_handler']</code> if no others match.</p>

<p>Matching is done by reducing the URL folder-by-folder until a file
 matches. Here are some examples:</p>

<pre><code> / -&gt; $conf[default_handler]

 /foo -&gt; apps/foo/handlers/index.php,
         $conf[default_handler]

 /user/login -&gt; apps/user/handlers/login.php,
                apps/user/handlers/index.php,
                $conf[default_handler]

 /user/info/123 -&gt; apps/user/handlers/info/123.php,
                   apps/user/handlers/info.php,
                   apps/user/handlers/index.php,
                   $conf[default_handler]
</code></pre>

<p>The controller simply returns the matching URL so you can include
 it via the following code:</p>

<pre><code> $handler = $controller-&gt;route ($_SERVER['REQUEST_URI']);
 ob_start ();
 require_once ($handler);
 $page-&gt;body = ob_get_clean ();
</code></pre>

<p>Or more simply (but in practice the same):</p>

<pre><code> $handler = $controller-&gt;route ($_SERVER['REQUEST_URI']);
 $page-&gt;body = $controller-&gt;handle ($handler);
</code></pre>

<p>In this way, there is less scaffolding code for individual controllers,
 they can simply begin executing in the global namespace just like an
 ordinary PHP script, and the output is simply echoed like an ordinary
 PHP script too.</p>

<p>The remaining elements of the URL are accessible in the array
 <code>$this-&gt;params</code>, so for <code>/user/123</code> handled by <code>handlers/user.php</code>,
 you could get the value <code>'123'</code> via <code>$this-&gt;params[0]</code>.</p>

<p>You can also call one handler from within another and get its results
 like this:</p>

<pre><code> $res = $this-&gt;run ('/user/123');
</code></pre>

<p>Sometimes you might want to pass values to another handler for internal
 processing, which you can do like this:</p>

<pre><code> $res = $this-&gt;run ('/user/123', array ('foo' =&gt; 'bar'));
</code></pre>

<p>You can then access the array via:</p>

<pre><code> echo $this-&gt;data['foo'];
</code></pre>

<p>In addition to running one handler from another, you can configure
 hooks with one or more handlers to be run for you when you trigger
 the hook. This is a 3-step process:</p>

<ol>
<li><p>Add your hook and its handler to <code>conf/config.php</code>:</p>

<p>myapp/somehandler[] = otherapp/handler</p></li>
<li><p>In <code>myapp/somehandler</code>, add the hook call and pass it some data:</p>

<p>$this->hook ('myapp/somehandler', array('id' => 123));</p></li>
<li><p>In <code>otherapp/handler</code>, verify the request and do something
interesting with the id:</p>

<p>&lt;?php</p>

<p>if (! $this->internal) {
     die ('Cannot call me from a browser.');
 }</p>

<p>if (! Form::verify_value ($this->data['id'], 'type', 'numeric')) {
     die ('Invalid id value');
 }</p>

<p>do something with $this->data['id']</p>

<p>?></p></li>
</ol>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">class</span> <span class="nc">Controller</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-1">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Extra parameters from the end of the URL.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">var</span> <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Whether the request originated internally or externally.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">var</span> <span class="nv">$internal</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-3">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Data sent from another handler to the current one.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">var</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-4">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Set to true if the request came from the command line.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">var</span> <span class="nv">$cli</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-5">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>A list of handlers defined to be called for each type of hook.
 Similar to the idea of webhooks, this provides a means of triggering
 handlers from each other without hard-coding the specific handlers in
 the triggering code. See <code>conf/config.php</code>'s <code>[Hooks]</code> section for examples.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">var</span> <span class="nv">$hooks</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-6">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Keeps track of the number of times each handler has been called in
 this request. You can check <code>$controller-&gt;called['handler']</code> for
 the number, but make sure you use $controller and not $this in
 handlers to make sure it refers to the global controller.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">var</span> <span class="nv">$called</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-7">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>When a handler is loaded, if there is a <code>conf/config.php</code> for that
 app, its contents will be loaded into <code>$appconf['appname']</code> once
 the first time it is called, and accessible thereafter by any
 handler in that app directly via $appconf.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">var</span> <span class="nv">$appconf</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>

 <span class="k">function</span> <span class="nf">__construct</span> <span class="p">(</span><span class="nv">$hooks</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="p">(</span><span class="s1">&#39;STDIN&#39;</span><span class="p">))</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cli</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hooks</span> <span class="o">=</span> <span class="nv">$hooks</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-8">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Run an internal request from one handler to another.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">run</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="k">global</span> <span class="nv">$controller</span><span class="p">;</span>
  <span class="nv">$c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Controller</span><span class="p">;</span>
  <span class="nv">$handler</span> <span class="o">=</span> <span class="nv">$c</span><span class="o">-&gt;</span><span class="na">route</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">called</span><span class="p">[</span><span class="nv">$uri</span><span class="p">]))</span> <span class="p">{</span>
   <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">called</span><span class="p">[</span><span class="nv">$uri</span><span class="p">]</span> <span class="o">=</span> <span class="m">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">called</span><span class="p">[</span><span class="nv">$uri</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nv">$c</span><span class="o">-&gt;</span><span class="na">handle</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-9">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Trigger the default error handler. Note that you must echo the
 output from your handler before returning, for example:</p>

<pre><code> echo $this-&gt;error ();
 return;
</code></pre>

<p>Not like this:</p>

<pre><code> return $this-&gt;error ();
</code></pre>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">error</span> <span class="p">(</span><span class="nv">$code</span> <span class="o">=</span> <span class="m">404</span><span class="p">,</span> <span class="nv">$title</span> <span class="o">=</span> <span class="s1">&#39;Page not found&#39;</span><span class="p">,</span> <span class="nv">$message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">global</span> <span class="nv">$conf</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-10">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Erase any existing output up to this point</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nb">ob_clean</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-11">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Call the error handler</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">run</span> <span class="p">(</span><span class="nv">$conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;error_handler&#39;</span><span class="p">],</span> <span class="k">array</span> <span class="p">(</span>
   <span class="s1">&#39;code&#39;</span> <span class="o">=&gt;</span> <span class="nv">$code</span><span class="p">,</span>
   <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
   <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="nv">$message</span>
  <span class="p">));</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-12">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Run any handlers for the specified hook type. Note that the
 output for hooks is ignored.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">hook</span> <span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hooks</span><span class="p">[</span><span class="nv">$type</span><span class="p">]))</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hooks</span><span class="p">[</span><span class="nv">$type</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$handler</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">run</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-13">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Execute the request handler. $internal determines whether the
 request originated internally from another handler or template,
 or externally from a browser request.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">handle</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$internal</span> <span class="o">=</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span> <span class="p">())</span> <span class="p">{</span>
  <span class="k">global</span> <span class="nv">$controller</span><span class="p">,</span> <span class="nv">$db</span><span class="p">,</span> <span class="nv">$conf</span><span class="p">,</span> <span class="nv">$i18n</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="nv">$tpl</span><span class="p">,</span> <span class="nv">$memcache</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">internal</span> <span class="o">=</span> <span class="nv">$internal</span><span class="p">;</span>
  <span class="nv">$data</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$data</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span> <span class="p">(</span><span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">]))</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">.</span> <span class="s1">&#39;/conf/config.php&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parse_ini_file</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">.</span> <span class="s1">&#39;/conf/config.php&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
   <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$appconf</span> <span class="o">=</span> <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">appconf</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">];</span>
  <span class="nb">ob_start</span> <span class="p">();</span>
  <span class="k">require</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">ob_get_clean</span> <span class="p">();</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-14">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Route a request URI to a file.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">route</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">global</span> <span class="nv">$conf</span><span class="p">;</span>
  <span class="nv">$exp</span> <span class="o">=</span> <span class="nb">explode</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;default_handler&#39;</span><span class="p">]);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">=</span> <span class="nb">array_shift</span> <span class="p">(</span><span class="nv">$exp</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span></pre></div>            </td>
          </tr>
                  <tr id="section-15">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Remove queries and hash from uri</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">preg_replace</span> <span class="p">(</span><span class="s1">&#39;/(\?|#).*$/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">clean</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$uri</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;default_handler&#39;</span><span class="p">];</span>
  <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-16">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Remove leading /</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">ltrim</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-17">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If no / and doesn't match an app's name with an index.php</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-18">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>handler, then use the default handler.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">strstr</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$uri</span> <span class="o">.</span> <span class="s1">&#39;/handlers/index.php&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$uri</span> <span class="o">.=</span> <span class="s1">&#39;/index&#39;</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">add_param</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>
    <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;default_handler&#39;</span><span class="p">];</span>
   <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">list</span> <span class="p">(</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$handler</span><span class="p">)</span> <span class="o">=</span> <span class="nb">preg_split</span> <span class="p">(</span><span class="s1">&#39;/\//&#39;</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="m">2</span><span class="p">);</span>
  <span class="nv">$route</span> <span class="o">=</span> <span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers/&#39;</span> <span class="o">.</span> <span class="nv">$handler</span> <span class="o">.</span> <span class="s1">&#39;.php&#39;</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="nv">$route</span><span class="p">))</span> <span class="p">{</span>
   <span class="nv">$route</span> <span class="o">=</span> <span class="nb">preg_replace</span> <span class="p">(</span><span class="s1">&#39;/\/([^\/]*)\.php$/e&#39;</span><span class="p">,</span> <span class="s1">&#39;$this-&gt;add_param (\&#39;\\1\&#39;)&#39;</span><span class="p">,</span> <span class="nv">$route</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="nv">$route</span> <span class="o">==</span> <span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers.php&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">@</span><span class="nb">file_exists</span> <span class="p">(</span><span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers/index.php&#39;</span><span class="p">))</span> <span class="p">{</span>
     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">=</span> <span class="nv">$app</span><span class="p">;</span>
     <span class="k">return</span> <span class="s1">&#39;apps/&#39;</span> <span class="o">.</span> <span class="nv">$app</span> <span class="o">.</span> <span class="s1">&#39;/handlers/index.php&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">vsprintf</span> <span class="p">(</span>
     <span class="s1">&#39;apps/%s/handlers/%s.php&#39;</span><span class="p">,</span>
     <span class="nb">explode</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;default_handler&#39;</span><span class="p">])</span>
    <span class="p">);</span>
   <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span> <span class="o">=</span> <span class="nv">$app</span><span class="p">;</span>
  <span class="k">return</span> <span class="nv">$route</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-19">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Is this URL clean of any directory manipulation attempts?</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">clean</span> <span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">strstr</span> <span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-20">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Adds to the start, since <code>route()</code> parse them off the end of the URI.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">add_param</span> <span class="p">(</span><span class="nv">$param</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">array_unshift</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">,</span> <span class="nv">$param</span><span class="p">);</span>
  <span class="k">return</span> <span class="s1">&#39;.php&#39;</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-21">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Add a notification to the <code>elefant_notification</code> cookie, which is
 monitored by <code>admin/head</code> and will be displayed using jGrowl. Handy
 for setting confirmation messages and other notices for the current
 user to display on a subsequent screen.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">add_notification</span> <span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span> <span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;elefant_notification&#39;</span><span class="p">]))</span> <span class="p">{</span>
   <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;elefant_notification&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;|&#39;</span> <span class="o">.</span> <span class="nv">$msg</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">setcookie</span> <span class="p">(</span><span class="s1">&#39;elefant_notification&#39;</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-22">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Redirect the current request and exit.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">redirect</span> <span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$exit</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">header</span> <span class="p">(</span><span class="s1">&#39;Location: &#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$exit</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">exit</span><span class="p">;</span>
  <span class="p">}</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-23">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Check if an app and version have been installed. Returns true if
 installed, false if not, and current installed version if an upgrade
 should be performed.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">installed</span> <span class="p">(</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$version</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$v</span> <span class="o">=</span> <span class="nx">db_shift</span> <span class="p">(</span><span class="s1">&#39;select version from apps where name = ?&#39;</span><span class="p">,</span> <span class="nv">$app</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">version_compare</span> <span class="p">(</span><span class="nv">$version</span><span class="p">,</span> <span class="nv">$v</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$v</span><span class="p">;</span>
 <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-24">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Mark an app and version as installed.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre> <span class="k">function</span> <span class="nf">mark_installed</span> <span class="p">(</span><span class="nv">$app</span><span class="p">,</span> <span class="nv">$version</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$v</span> <span class="o">=</span> <span class="nx">db_shift</span> <span class="p">(</span><span class="s1">&#39;select version from apps where name = ?&#39;</span><span class="p">,</span> <span class="nv">$app</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">db_execute</span> <span class="p">(</span><span class="s1">&#39;update apps set version = ? where name = ?&#39;</span><span class="p">,</span> <span class="nv">$version</span><span class="p">,</span> <span class="nv">$app</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">db_execute</span> <span class="p">(</span><span class="s1">&#39;insert into apps (name, version) values (?, ?)&#39;</span><span class="p">,</span> <span class="nv">$app</span><span class="p">,</span> <span class="nv">$version</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
</pre></div></pre></div>            </td>
          </tr>
              </tbody>
    </table>
  </div>
</body>
</html>
