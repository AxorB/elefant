<style>
.redactor_box {
	border: 0;
	background: #f5f5f5;
}

.redactor_toolbar {
	border: 0;
	background: #f5f5f5;
}

.redactor_toolbar li.redactor_separator {
	border: 0;
	background-image: url(/apps/admin/css/admin/pipe.png);
	background-repeat: no-repeat;
	background-position: 0px 9px;
	width: 1px;
}

.redactor_editor, .redactor_box textarea {
	border: 1px solid #999;
	-webkit-border-radius: 2px;
	-moz-border-radius: 2px;
	border-radius: 2px;
	width: 654px !important;
	height: 418px !important;
	padding: 5px !important;
}

.redactor_editor:focus {
	height: 418px !important;
	padding: 5px !important;
}

.redactor_toolbar li a.redactor_btn_undo {
	background-image: url(/apps/admin/css/admin/undo-icon.png);
	background-repeat: no-repeat;
	background-position: 0px 0px;
}

.redactor_toolbar li a.redactor_btn_dynamic {
	background-image: url(/apps/admin/css/admin/dynamic-icon.png);
	background-repeat: no-repeat;
	background-position: 4px 4px;
}
</style>

<script>
$(function () {
	/**
	 * TO DO:
	 *
	 * - Insertion of embed codes for swf, mp4, and mp3 files
	 * - Dynamic objects dialog
	 * - Page list in link dialog
	 * - Browse files in image dialog
	 * - Click to edit dynamic objects
	 * - Make sure autosave updates editor
	 */

	$('#{{ field_id }}')
		.removeAttr ('cols')
		.removeAttr ('rows')
		.redactor ({
			lang: '{{i18n.language|none}}',
			plugins: ['dynamic'],
			buttons: [
				'formatting', '|', 'bold', 'italic', 'deleted', '|',
				'alignment', 'horizontalrule', '|', 'unorderedlist', 'orderedlist', 'outdent', 'indent', '|',
				'link', 'image', 'file', 'table', '|',
				'undo', 'html', 'dynamic'
			],
			buttonsCustom: {
				undo: {
					title: '{"Undo"}',
					dropdown: {
						point1: {
							title: '{"Undo"}',
							callback: undo
						},
						point2: {
							title: '{"Redo"}',
							callback: redo
						}
					}
				}
			},
			imageGetJson: '/filemanager/redactor/images',
			imageUpload: '/filemanager/redactor/upload',
			fileUpload: '/filemanager/redactor/upload',
			imageUploadErrorCallback: upload_error,
			fileUploadErrorCallback: upload_error
		});

	function undo (obj, evt, key) {
		obj.execCommand ('undo');
	}

	function redo (obj, evt, key) {
		obj.execCommand ('redo');
	}

	function upload_error (obj, json) {
		console.log (obj);
		console.log (json);
	}

	/*
		initialContent: '<p><br /></p>',
<?php if (file_exists ('js/wysiwyg/i18n/lang.' . $GLOBALS['i18n']->language . '.js')) { ?>
		plugins: {
			i18n: { lang: '{{i18n.language|none}}' }
		},
<?php } ?>
		controls: {
			strikeThrough	:{visible:false},
			justifyFull		:{visible:false},
			paragraph		:{visible:true},
			removeFormat	:{visible:true},
			html			:{visible:true},
			'fileManager': {
				visible: true,
				groupIndex: 12,
				tooltip: '{"File Manager"}',
				exec: function () {
					$.wysiwyg.fileManager.init (function (file) {
						if (file.match (/\.(jpg|png|gif)$/i)) {
							$('#webpage-body').wysiwyg ('insertImage', file);
						} else if (file.match (/\.swf$/i)) {
							$('#webpage-body').wysiwyg ('insertHtml', '<p><span class="embedded" data-embed="filemanager/swf?file=' + file + '" data-label="{"Embedded Flash (SWF)"}" title="{"Click to edit."}"></span></p><p><br /></p>');
						} else if (file.match (/\.mp4$/i)) {
							$('#webpage-body').wysiwyg ('insertHtml', '<p><span class="embedded" data-embed="filemanager/video?file=' + file + '" data-label="{"Embedded Video (MP4)"}" title="{"Click to edit."}"></span></p><p><br /></p>');
						} else if (file.match (/\.mp3$/i)) {
							$('#webpage-body').wysiwyg ('insertHtml', '<p><span class="embedded" data-embed="filemanager/audio?file=' + file + '" data-label="{"Embedded Audio (MP3)"}" title="{"Click to edit."}"></span></p><p><br /></p>');
						} else {
							$('#webpage-body').wysiwyg ('createLink', file);
						}
					});
				}
			},
			'dynamic': {
				visible: true,
				tooltip: '{"Dynamic Objects"}',
				tags: ['span'],
				exec: function () {
					$.wysiwyg.embed.init (this, wysiwyg_embed_update);
				}
			}
		},
		//dialog:'jqueryui',
		css: '/css/wysiwyg/default.css',
		'events': {
			click: function (e) {
				var range;
				
				if ($(e.target).hasClass ('embedded')) {
					
					var body = document.body, range, sel, el = e.target;
					if (document.createRange && window.getSelection) {
						range = document.createRange();
						sel = window.getSelection();
						sel.removeAllRanges();
						try {
							range.selectNodeContents (el);
							sel.addRange (range);
						} catch (e) {
							range.selectNode (el);
							sel.addRange (range);
						}
					} else if (body.createTextRange) {
						range = body.createTextRange ();
						range.moveToElementText (el);
						range.select ();
					}
					
					$.wysiwyg.embed.init ($('#webpage-body').data ('wysiwyg'), wysiwyg_embed_update, e.target);
				}

				try {
					$('form').autosave ();
				} catch (ex) {}
			}
		}
	});
	$.wysiwyg.fileManager.setAjaxHandler ('http://{{ $_SERVER.HTTP_HOST }}/filemanager/embed');

	function wysiwyg_embed_update (existing, embed_code, label) {
		if (! existing) {
			$('#webpage-body').wysiwyg ('insertHtml', '<p><span class="embedded" data-embed="' + embed_code + '" data-label="' + label + '" title="{"Click to edit."}"></span></p><p><br /></p>');
		} else {
			$(existing).replaceWith ('<span class="embedded" data-embed="' + embed_code + '" data-label="' + label + '" title="{"Click to edit."}"></span>');			
		}
	}*/
});
</script>
